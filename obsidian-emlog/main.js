/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var it=Object.create;var U=Object.defineProperty;var nt=Object.getOwnPropertyDescriptor;var at=Object.getOwnPropertyNames;var rt=Object.getPrototypeOf,ot=Object.prototype.hasOwnProperty;var lt=(I,E)=>()=>(E||I((E={exports:{}}).exports,E),E.exports),ct=(I,E)=>{for(var t in E)U(I,t,{get:E[t],enumerable:!0})},Q=(I,E,t,s)=>{if(E&&typeof E=="object"||typeof E=="function")for(let e of at(E))!ot.call(I,e)&&e!==t&&U(I,e,{get:()=>E[e],enumerable:!(s=nt(E,e))||s.enumerable});return I};var ht=(I,E,t)=>(t=I!=null?it(rt(I)):{},Q(E||!I||!I.__esModule?U(t,"default",{value:I,enumerable:!0}):t,I)),ut=I=>Q(U({},"__esModule",{value:!0}),I);var tt=lt((Z,x)=>{(function(I){"use strict";function E(i,w){var r=(i&65535)+(w&65535),v=(i>>16)+(w>>16)+(r>>16);return v<<16|r&65535}function t(i,w){return i<<w|i>>>32-w}function s(i,w,r,v,P,M){return E(t(E(E(w,i),E(v,M)),P),r)}function e(i,w,r,v,P,M,C){return s(w&r|~w&v,i,w,P,M,C)}function n(i,w,r,v,P,M,C){return s(w&v|r&~v,i,w,P,M,C)}function o(i,w,r,v,P,M,C){return s(w^r^v,i,w,P,M,C)}function a(i,w,r,v,P,M,C){return s(r^(w|~v),i,w,P,M,C)}function d(i,w){i[w>>5]|=128<<w%32,i[(w+64>>>9<<4)+14]=w;var r,v,P,M,C,c=1732584193,h=-271733879,u=-1732584194,p=271733878;for(r=0;r<i.length;r+=16)v=c,P=h,M=u,C=p,c=e(c,h,u,p,i[r],7,-680876936),p=e(p,c,h,u,i[r+1],12,-389564586),u=e(u,p,c,h,i[r+2],17,606105819),h=e(h,u,p,c,i[r+3],22,-1044525330),c=e(c,h,u,p,i[r+4],7,-176418897),p=e(p,c,h,u,i[r+5],12,1200080426),u=e(u,p,c,h,i[r+6],17,-1473231341),h=e(h,u,p,c,i[r+7],22,-45705983),c=e(c,h,u,p,i[r+8],7,1770035416),p=e(p,c,h,u,i[r+9],12,-1958414417),u=e(u,p,c,h,i[r+10],17,-42063),h=e(h,u,p,c,i[r+11],22,-1990404162),c=e(c,h,u,p,i[r+12],7,1804603682),p=e(p,c,h,u,i[r+13],12,-40341101),u=e(u,p,c,h,i[r+14],17,-1502002290),h=e(h,u,p,c,i[r+15],22,1236535329),c=n(c,h,u,p,i[r+1],5,-165796510),p=n(p,c,h,u,i[r+6],9,-1069501632),u=n(u,p,c,h,i[r+11],14,643717713),h=n(h,u,p,c,i[r],20,-373897302),c=n(c,h,u,p,i[r+5],5,-701558691),p=n(p,c,h,u,i[r+10],9,38016083),u=n(u,p,c,h,i[r+15],14,-660478335),h=n(h,u,p,c,i[r+4],20,-405537848),c=n(c,h,u,p,i[r+9],5,568446438),p=n(p,c,h,u,i[r+14],9,-1019803690),u=n(u,p,c,h,i[r+3],14,-187363961),h=n(h,u,p,c,i[r+8],20,1163531501),c=n(c,h,u,p,i[r+13],5,-1444681467),p=n(p,c,h,u,i[r+2],9,-51403784),u=n(u,p,c,h,i[r+7],14,1735328473),h=n(h,u,p,c,i[r+12],20,-1926607734),c=o(c,h,u,p,i[r+5],4,-378558),p=o(p,c,h,u,i[r+8],11,-2022574463),u=o(u,p,c,h,i[r+11],16,1839030562),h=o(h,u,p,c,i[r+14],23,-35309556),c=o(c,h,u,p,i[r+1],4,-1530992060),p=o(p,c,h,u,i[r+4],11,1272893353),u=o(u,p,c,h,i[r+7],16,-155497632),h=o(h,u,p,c,i[r+10],23,-1094730640),c=o(c,h,u,p,i[r+13],4,681279174),p=o(p,c,h,u,i[r],11,-358537222),u=o(u,p,c,h,i[r+3],16,-722521979),h=o(h,u,p,c,i[r+6],23,76029189),c=o(c,h,u,p,i[r+9],4,-640364487),p=o(p,c,h,u,i[r+12],11,-421815835),u=o(u,p,c,h,i[r+15],16,530742520),h=o(h,u,p,c,i[r+2],23,-995338651),c=a(c,h,u,p,i[r],6,-198630844),p=a(p,c,h,u,i[r+7],10,1126891415),u=a(u,p,c,h,i[r+14],15,-1416354905),h=a(h,u,p,c,i[r+5],21,-57434055),c=a(c,h,u,p,i[r+12],6,1700485571),p=a(p,c,h,u,i[r+3],10,-1894986606),u=a(u,p,c,h,i[r+10],15,-1051523),h=a(h,u,p,c,i[r+1],21,-2054922799),c=a(c,h,u,p,i[r+8],6,1873313359),p=a(p,c,h,u,i[r+15],10,-30611744),u=a(u,p,c,h,i[r+6],15,-1560198380),h=a(h,u,p,c,i[r+13],21,1309151649),c=a(c,h,u,p,i[r+4],6,-145523070),p=a(p,c,h,u,i[r+11],10,-1120210379),u=a(u,p,c,h,i[r+2],15,718787259),h=a(h,u,p,c,i[r+9],21,-343485551),c=E(c,v),h=E(h,P),u=E(u,M),p=E(p,C);return[c,h,u,p]}function y(i){var w,r="",v=i.length*32;for(w=0;w<v;w+=8)r+=String.fromCharCode(i[w>>5]>>>w%32&255);return r}function S(i){var w,r=[];for(r[(i.length>>2)-1]=void 0,w=0;w<r.length;w+=1)r[w]=0;var v=i.length*8;for(w=0;w<v;w+=8)r[w>>5]|=(i.charCodeAt(w/8)&255)<<w%32;return r}function g(i){return y(d(S(i),i.length*8))}function l(i,w){var r,v=S(i),P=[],M=[],C;for(P[15]=M[15]=void 0,v.length>16&&(v=d(v,i.length*8)),r=0;r<16;r+=1)P[r]=v[r]^909522486,M[r]=v[r]^1549556828;return C=d(P.concat(S(w)),512+w.length*8),y(d(M.concat(C),512+128))}function f(i){var w="0123456789abcdef",r="",v,P;for(P=0;P<i.length;P+=1)v=i.charCodeAt(P),r+=w.charAt(v>>>4&15)+w.charAt(v&15);return r}function T(i){return unescape(encodeURIComponent(i))}function $(i){return g(T(i))}function O(i){return f($(i))}function A(i,w){return l(T(i),T(w))}function D(i,w){return f(A(i,w))}function F(i,w,r){return w?r?A(w,i):D(w,i):r?$(i):O(i)}typeof define=="function"&&define.amd?define(function(){return F}):typeof x=="object"&&x.exports?x.exports=F:I.md5=F})(Z)});var pt={};ct(pt,{default:()=>N});module.exports=ut(pt);var m=require("obsidian"),R=ht(tt()),V,et,st;try{V=(st=(et=require("electron"))==null?void 0:et.shell)==null?void 0:st.openExternal}catch(I){}var L={baseUrl:"",authMode:"sign",apiKey:"",defaultAuthorUid:"",defaultSortId:"",defaultDraft:!0,autoCover:!0,allowRemark:!0,postAction:"open",enableDebug:!1},G="emlog-panel",N=class extends m.Plugin{constructor(){super(...arguments);this.articleMap={};this.statusEl=null;this.cachedSorts=[];this.lastMarkdownFile=null}async onload(){await this.loadSettings(),this.statusEl=this.addStatusBarItem(),this.setStatus("\u5C31\u7EEA"),this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{let s=t==null?void 0:t.view;s&&s.file&&s instanceof m.MarkdownView&&(this.lastMarkdownFile=s.file)})),this.registerView(G,t=>new K(t,this)),this.addRibbonIcon("dice","\u6253\u5F00 EMLOG \u9762\u677F",()=>{this.activatePanelView()}),this.addCommand({id:"emlog-open-panel",name:"\u6253\u5F00/\u5207\u6362 EMLOG \u9762\u677F",callback:()=>this.activatePanelView()}),this.addCommand({id:"emlog-publish-current",name:"\u53D1\u5E03\u5F53\u524D\u7B14\u8BB0\u5230 EMLOG",callback:()=>this.publishCurrentNote(!1)}),this.addCommand({id:"emlog-publish-draft",name:"\u53D1\u5E03\u4E3A\u8349\u7A3F\u5230 EMLOG",callback:()=>this.publishCurrentNote(!0)}),this.addCommand({id:"emlog-publish-note",name:"\u53D1\u5E03\u5FAE\u8BED\uFF08\u5F53\u524D\u9009\u4E2D\u6587\u672C\u6216\u63D0\u793A\u8F93\u5165\uFF09",callback:()=>this.publishNote()}),this.addCommand({id:"emlog-publish-custom",name:"\u81EA\u5B9A\u4E49\u53D1\u5E03\u2026",callback:()=>{var s,e;let t=((s=this.app.workspace.getActiveViewOfType(m.MarkdownView))==null?void 0:s.file)||this.lastMarkdownFile;if(!t){new m.Notice("\u672A\u68C0\u6D4B\u5230 Markdown \u6587\u4EF6");return}new m.Notice("\u6253\u5F00\u81EA\u5B9A\u4E49\u53D1\u5E03\u7A97\u53E3\u2026"),this.openPublishModal(t,(e=this.app.workspace.getActiveViewOfType(m.MarkdownView))==null?void 0:e.editor)}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,s,e)=>{e!=null&&e.file&&(t.addItem(n=>n.setTitle("\u53D1\u5E03\u5230 EMLOG\uFF08\u6B63\u5F0F\uFF09").setIcon("paper-plane").onClick(()=>this.publishFromContext(s,e,!1))),t.addItem(n=>n.setTitle("\u53D1\u5E03\u5230 EMLOG\uFF08\u8349\u7A3F\uFF09").setIcon("paper-plane").onClick(()=>this.publishFromContext(s,e,!0))),t.addItem(n=>n.setTitle("\u81EA\u5B9A\u4E49\u53D1\u5E03\u2026").setIcon("forms").onClick(()=>this.openPublishModal(e.file||this.lastMarkdownFile))),t.addSeparator(),t.addItem(n=>n.setTitle("\u53D1\u5E03\u5FAE\u8BED\uFF08\u9009\u4E2D\u6587\u672C\uFF09").setIcon("message-square").onClick(async()=>{var a;let o=s.getSelection();if(!o){new m.Notice("\u8BF7\u9009\u62E9\u8981\u53D1\u5E03\u4E3A\u5FAE\u8BED\u7684\u6587\u672C");return}try{await this.httpForm("note_post",{t:o}),new m.Notice("\u5FAE\u8BED\u53D1\u5E03\u6210\u529F")}catch(d){new m.Notice(`\u5FAE\u8BED\u53D1\u5E03\u5931\u8D25\uFF1A${(a=d.message)!=null?a:d}`)}})))})),this.registerEvent(this.app.workspace.on("file-menu",(t,s)=>{!(s instanceof m.TFile)||s.extension!=="md"||(t.addItem(e=>e.setTitle("\u53D1\u5E03\u5230 EMLOG\uFF08\u6B63\u5F0F\uFF09").setIcon("paper-plane").onClick(async()=>{let n=await this.app.vault.cachedRead(s);await this.publishCore(s,n,!1,{})})),t.addItem(e=>e.setTitle("\u53D1\u5E03\u5230 EMLOG\uFF08\u8349\u7A3F\uFF09").setIcon("paper-plane").onClick(async()=>{let n=await this.app.vault.cachedRead(s);await this.publishCore(s,n,!0,{})})),t.addItem(e=>e.setTitle("\u81EA\u5B9A\u4E49\u53D1\u5E03\u2026").setIcon("forms").onClick(()=>this.openPublishModal(s))))})),this.addSettingTab(new H(this.app,this))}onunload(){}async loadSettings(){let t=await this.loadData();if(!t){this.settings={...L},this.articleMap={};return}t.settings?(this.settings={...L,...t.settings},this.articleMap=t.articleMap||{}):(this.settings={...L,...t},this.articleMap={})}async saveState(){let t={settings:this.settings,articleMap:this.articleMap};await this.saveData(t)}async saveSettings(){await this.saveState()}setStatus(t){this.statusEl&&this.statusEl.setText(`EMLOG: ${t}`)}debug(...t){if(!this.settings.enableDebug)return;let s=e=>{try{if(typeof e=="string")return this.redactString(e);if(typeof e=="object"&&e!==null){let n=JSON.stringify(e);return this.redactString(n)}return e}catch(n){return e}};try{console.debug("[obsidian-emlog]",...t.map(s))}catch(e){}}redactString(t){let s=t;if(this.settings.apiKey){let e=this.escapeRegExp(this.settings.apiKey);s=s.replace(new RegExp(e,"g"),"***")}return s=s.replace(/"req_sign"\s*:\s*"[a-fA-F0-9]{16,}"/g,'"req_sign":"***"'),s}getActiveMarkdown(){let t=this.app.workspace.getActiveViewOfType(m.MarkdownView);return t!=null&&t.file?{editor:t.editor,view:t,file:t.file}:this.lastMarkdownFile?{file:this.lastMarkdownFile}:(new m.Notice("\u672A\u627E\u5230\u6D3B\u52A8\u7684 Markdown \u7A97\u53E3"),null)}deriveTitle(t,s,e){if(e!=null&&e.title)return String(e.title);if(s!=null&&s.basename)return s.basename;let n=t.split(`
`);for(let o of n){let a=o.trim();if(a.startsWith("# "))return a.substring(2).trim()}return"\u65E0\u6807\u9898\u6587\u7AE0"}deriveExcerpt(t,s){if(s!=null&&s.excerpt)return String(s.excerpt);let e=t;if(e.startsWith(`---
`)){let a=e.indexOf(`
---
`,4);a!==-1&&(e=e.substring(a+5))}let o=e.split(`
`).filter(a=>{let d=a.trim();return d&&!d.startsWith("#")}).join(" ").replace(/!\[.*?\]\(.*?\)/g,"").trim();return o.length>150?o.substring(0,150)+"...":o}extractFrontmatter(t){let s=this.app.metadataCache.getFileCache(t);return s==null?void 0:s.frontmatter}removeFromContent(t){if(!t.startsWith(`---
`))return t;let s=t.indexOf(`
---
`,4);return s===-1?t:t.substring(s+5)}async publishCore(t,s,e,n){var F,i,w,r,v,P,M,C,c,h,u,p,B,j,J,W,Y,X,z;let o=this.extractFrontmatter(t)||{},a=this.deriveTitle(s,t,o),d=(F=n.title)!=null?F:a,y=this.deriveExcerpt(s,o),S=(i=n.excerpt)!=null?i:y,g=(w=n.tags)!=null?w:Array.isArray(o.tags)?o.tags.map(String).join(","):typeof o.tags=="string"?o.tags:"",l=(P=n.sortId)!=null?P:((r=o.sort_id)!=null?r:this.settings.defaultSortId)?String((v=o.sort_id)!=null?v:this.settings.defaultSortId):"",f=((M=o.author_uid)!=null?M:this.settings.defaultAuthorUid)?String((C=o.author_uid)!=null?C:this.settings.defaultAuthorUid):"",T=n.postDate,$=(c=n.coverImage)!=null?c:o.cover_image||o.coverImage||"",O=e?!0:n.draft!=null?n.draft:o.draft==="y"||o.draft===!0;this.setStatus("\u4E0A\u4F20\u56FE\u7247\u4E2D...");let A=this.removeFromContent(s);try{A=(await this.processImages(A,t)).content}catch(b){this.debug("\u5904\u7406\u56FE\u7247\u5931\u8D25",(h=b==null?void 0:b.message)!=null?h:String(b))}let D=this.articleMap[t.path]!=null;this.setStatus(D?"\u66F4\u65B0\u6587\u7AE0\u4E2D...":"\u53D1\u5E03\u6587\u7AE0\u4E2D..."),new m.Notice(D?"\u6B63\u5728\u66F4\u65B0\u5230 EMLOG...":"\u6B63\u5728\u53D1\u5E03\u5230 EMLOG..."),this.debug("\u5F00\u59CB\u53D1\u5E03\u6587\u7AE0",{isUpdate:D,title:d,contentLength:A.length,sortId:l,tags:g,draftFlag:O,authMode:this.settings.authMode,baseUrl:this.settings.baseUrl});try{if(D){let b=Number(this.articleMap[t.path]);await this.httpForm("article_update",{id:String(b),title:d,content:A,excerpt:S,...g?{tags:g}:{},...l?{sort_id:l}:{},...f?{author_uid:f}:{},draft:O?"y":"n",...T?{post_date:T}:{},...$?{cover:$}:{}}),new m.Notice(`\u66F4\u65B0\u6210\u529F\uFF1A${d} (ID: ${b})`),this.setStatus("\u66F4\u65B0\u6210\u529F"),await this.performPostAction(b,O);let k=await this.fetchArticleUrlById(b);await this.upsertFrontmatterKeys(t,{published:!O,sort_id:l||((u=o.sort_id)!=null?u:""),emlog_article_id:b,publish_date:this.formatDate(),url:k||""})}else{let b=await this.httpForm("article_post",{title:d,content:A,excerpt:S,...g?{tags:g}:{},...l?{sort_id:l}:{},...f?{author_uid:f}:{},draft:O?"y":"n",allow_remark:this.settings.allowRemark?"y":"n",auto_cover:this.settings.autoCover?"y":"n",...T?{post_date:T}:{},...$?{cover:$}:{}}),k=((p=b==null?void 0:b.data)==null?void 0:p.article_id)||(b==null?void 0:b.article_id);this.debug("\u53D1\u5E03\u54CD\u5E94\u6570\u636E",{data:b,articleId:k}),k&&(this.articleMap[t.path]=k,await this.saveState()),new m.Notice(`\u53D1\u5E03\u6210\u529F\uFF1A${d} (ID: ${k!=null?k:"\u672A\u77E5"})`),this.setStatus("\u53D1\u5E03\u6210\u529F"),await this.performPostAction(k!=null?k:null,O);let _=k?await this.fetchArticleUrlById(k):null;await this.upsertFrontmatterKeys(t,{published:!O,sort_id:l||((B=o.sort_id)!=null?B:""),emlog_article_id:k||"",publish_date:this.formatDate(),url:_||""})}}catch(b){let k={message:(b==null?void 0:b.message)||String(b),stack:b==null?void 0:b.stack,name:b==null?void 0:b.name,cause:b==null?void 0:b.cause,response:b==null?void 0:b.response,status:b==null?void 0:b.status,statusText:b==null?void 0:b.statusText};this.debug("\u53D1\u5E03\u5931\u8D25\u8BE6\u7EC6\u4FE1\u606F",k);let _=`\u53D1\u5E03\u5931\u8D25\uFF1A${(j=b.message)!=null?j:b}`;(J=b==null?void 0:b.message)!=null&&J.includes("401")?_+=`
\u{1F511} \u8BA4\u8BC1\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5 API Key \u548C\u8BA4\u8BC1\u65B9\u5F0F\u8BBE\u7F6E`:(W=b==null?void 0:b.message)!=null&&W.includes("404")?_+=`
\u{1F310} API \u8DEF\u5F84\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\u535A\u5BA2\u5730\u5740\u914D\u7F6E`:(Y=b==null?void 0:b.message)!=null&&Y.includes("timeout")?_+=`
\u23F1\uFE0F \u8BF7\u6C42\u8D85\u65F6\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5`:(X=b==null?void 0:b.message)!=null&&X.includes("CORS")?_+=`
\u{1F6AB} \u8DE8\u57DF\u8BF7\u6C42\u88AB\u963B\u6B62\uFF0C\u8FD9\u662F\u6D4F\u89C8\u5668\u5B89\u5168\u9650\u5236`:(z=b==null?void 0:b.message)!=null&&z.includes("Request failed")&&(_+=`
\u{1F4E1} \u7F51\u7EDC\u8BF7\u6C42\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u535A\u5BA2\u5730\u5740\u548C\u7F51\u7EDC\u8FDE\u63A5`),new m.Notice(_,1e4),this.setStatus("\u5931\u8D25")}}async publishFromContext(t,s,e){var a;let n=s==null?void 0:s.file;if(!n){new m.Notice("\u672A\u68C0\u6D4B\u5230 Markdown \u6587\u4EF6");return}let o=(a=t==null?void 0:t.getValue())!=null?a:await this.app.vault.cachedRead(n);await this.publishCore(n,o,e,{})}async publishCurrentNote(t){let s=this.getActiveMarkdown();if(!s)return;let{editor:e,file:n}=s,o=e?e.getValue():await this.app.vault.cachedRead(n);await this.publishCore(n,o,t,{})}async publishNote(){var n,o;let t="",s,e=this.app.workspace.getActiveViewOfType(m.MarkdownView);if(e!=null&&e.editor&&(s=e.editor,t=s.getSelection()),!t&&this.lastMarkdownFile){let a=this.app.workspace.getLeavesOfType("markdown").find(d=>{var S,g;let y=d.view;return((S=y==null?void 0:y.file)==null?void 0:S.path)===((g=this.lastMarkdownFile)==null?void 0:g.path)});if(a){let d=a.view;d!=null&&d.editor&&(s=d.editor,t=s.getSelection())}}if(!t){new m.Notice("\u8BF7\u9009\u62E9\u8981\u53D1\u5E03\u4E3A\u5FAE\u8BED\u7684\u6587\u672C");return}this.debug("\u53D1\u5E03\u5FAE\u8BED",{textLength:t.length,textPreview:t.substring(0,50)}),this.setStatus("\u53D1\u5E03\u5FAE\u8BED\u4E2D...");try{await this.httpForm("note_post",{t}),new m.Notice("\u5FAE\u8BED\u53D1\u5E03\u6210\u529F"),this.setStatus("\u5FAE\u8BED\u5DF2\u53D1\u5E03")}catch(a){new m.Notice(`\u5FAE\u8BED\u53D1\u5E03\u5931\u8D25\uFF1A${(n=a.message)!=null?n:a}`),this.setStatus("\u5931\u8D25"),this.debug("\u5FAE\u8BED\u5931\u8D25",(o=a==null?void 0:a.message)!=null?o:String(a))}}async activatePanelView(){let t=this.app.workspace.getRightLeaf(!1);if(t||(t=this.app.workspace.getRightLeaf(!0)),!t){new m.Notice("\u65E0\u6CD5\u6253\u5F00\u53F3\u4FA7\u9762\u677F");return}await t.setViewState({type:G,active:!0}),this.app.workspace.revealLeaf(t)}openPublishModal(t,s){if(!t){new m.Notice("\u672A\u627E\u5230\u8981\u53D1\u5E03\u7684 Markdown \u6587\u4EF6");return}new q(this.app,this,t,s).open()}async fetchArticleUrlById(t){var s,e,n,o;try{let a=await this.httpGet("article_detail",{id:String(t)}),d=((e=(s=a==null?void 0:a.data)==null?void 0:s.article)==null?void 0:e.url)||((n=a==null?void 0:a.article)==null?void 0:n.url);if(d)return d;let S=`${this.settings.baseUrl.replace(/\/$/,"")}/?post=${t}`;return this.debug("\u6784\u9020\u6587\u7AE0 URL",{id:t,constructedUrl:S}),S}catch(a){return this.debug("\u83B7\u53D6\u6587\u7AE0 URL \u5931\u8D25\uFF0C\u4F7F\u7528\u6784\u9020\u7684 URL",(o=a==null?void 0:a.message)!=null?o:String(a)),`${this.settings.baseUrl.replace(/\/$/,"")}/?post=${t}`}}async performPostAction(t,s){var o,a;if(s){new m.Notice("\u8349\u7A3F\u5DF2\u4FDD\u5B58\uFF08\u8349\u7A3F\u65E0\u516C\u5F00\u94FE\u63A5\uFF09");return}if(!t)return;let e=this.settings.postAction;if(e==="none")return;let n=await this.fetchArticleUrlById(t);if(n){if(e==="open"||e==="both")try{V?V(n):window.open(n,"_blank")}catch(d){window.open(n,"_blank")}if(e==="copy"||e==="both")try{await((a=(o=navigator.clipboard)==null?void 0:o.writeText)==null?void 0:a.call(o,n)),new m.Notice("\u6587\u7AE0\u94FE\u63A5\u5DF2\u590D\u5236")}catch(d){}}}flattenSorts(t,s=0){var n,o,a,d;let e=[];for(let y of t){let S=Number((o=(n=y.sid)!=null?n:y.id)!=null?o:y.sort_id),g=String((d=(a=y.sortname)!=null?a:y.name)!=null?d:"\u672A\u547D\u540D");e.push({id:S,name:g,depth:s}),Array.isArray(y.children)&&y.children.length>0&&e.push(...this.flattenSorts(y.children,s+1))}return e}async refreshSortOptions(){var t,s;try{let e=await this.httpGet("sort_list",{}),n=Array.isArray((t=e==null?void 0:e.data)==null?void 0:t.sorts)?e.data.sorts:Array.isArray(e==null?void 0:e.sorts)?e.sorts:[];this.cachedSorts=this.flattenSorts(n),this.debug("\u5206\u7C7B\u5DF2\u5237\u65B0",this.cachedSorts.length,"\u4E2A\u5206\u7C7B"),new m.Notice(`\u5DF2\u5237\u65B0 ${this.cachedSorts.length} \u4E2A\u5206\u7C7B`)}catch(e){new m.Notice(`\u83B7\u53D6\u5206\u7C7B\u5931\u8D25\uFF1A${(s=e.message)!=null?s:e}`),this.cachedSorts=[]}}populateSortDropdown(t){if(t.selectEl.textContent="",t.addOption("","\uFF08\u4E0D\u6307\u5B9A\uFF09"),!this.cachedSorts.length){t.addOption("__placeholder__",this.settings.baseUrl?"\u5C1A\u672A\u52A0\u8F7D\u5206\u7C7B\uFF0C\u70B9\u51FB\u53F3\u4FA7\u5237\u65B0":"\u8BF7\u5148\u914D\u7F6E\u7AD9\u70B9\u5730\u5740");return}for(let s of this.cachedSorts){let e=" ".repeat(s.depth*2);t.addOption(String(s.id),`${e}${s.name}`)}}getSortNameByIdPublic(t){if(t==null||t==="")return null;let s=Number(t),e=this.cachedSorts.find(n=>n.id===s);return e?e.name:null}formatDate(t=new Date){let s=e=>e.toString().padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())} ${s(t.getHours())}:${s(t.getMinutes())}:${s(t.getSeconds())}`}async upsertFrontmatterKeys(t,s){let e=this.app.metadataCache.getFileCache(t),n=await this.app.vault.read(t),o=e==null?void 0:e.frontmatterPosition,a=S=>typeof S=="boolean"||typeof S=="number"?String(S):JSON.stringify(String(S)),d=S=>{for(let[g,l]of Object.entries(s)){let f=new RegExp(`^${this.escapeRegExp(g)}s*:s*.*$`,"m");f.test(S)?S=S.replace(f,`${g}: ${a(l)}`):S+=`
${g}: ${a(l)}`}return S},y="";if(o){let S=n.slice(0,o.start.offset),g=n.slice(o.start.offset+4,o.end.offset-4),l=n.slice(o.end.offset),f=d(g);y=`${S}---
${f}
---${l}`}else if(n.startsWith(`---
`)){let S=n.indexOf(`
---`,4);if(S>0){let g=n.slice(4,S),l=n.slice(S+4);y=`---
${d(g)}
---${l}`}}if(!y){let S="";for(let[g,l]of Object.entries(s))S+=`${g}: ${a(l)}
`;y=`---
${S}---
${n}`}await this.app.vault.modify(t,y)}async httpForm(t,s){var y,S,g;let e=this.settings.baseUrl.replace(/\/$/,""),n=`${e}/?rest-api=${t}`,o={...s},a={"Content-Type":"application/x-www-form-urlencoded"};if(t==="article_post"||t==="article_update"||t==="note_post"){let l=Math.floor(Date.now()/1e3).toString();o.req_time=l,o.req_sign=(0,R.default)(l+this.settings.apiKey),this.debug("\u5F3A\u5236\u4F7F\u7528\u7B7E\u540D\u8BA4\u8BC1",{endpoint:t,req_time:l})}else if(this.settings.authMode==="sign"){let l=Math.floor(Date.now()/1e3).toString();o.req_time=l,o.req_sign=(0,R.default)(l+this.settings.apiKey)}else this.settings.authMode==="apikey"?a["X-API-Key"]=this.settings.apiKey:this.settings.authMode==="cookie"&&(a.Cookie=this.settings.apiKey);let d=new URLSearchParams(o).toString();this.debug("HTTP POST",n,"\u53C2\u6570\u957F\u5EA6:",d.length);try{let l=await(0,m.requestUrl)({url:n,method:"POST",headers:a,body:d});if(l.status===200){let f=JSON.parse(l.text);if(f.code===0||f.success)return this.debug("HTTP POST \u6210\u529F",f),f;throw this.debug("HTTP POST \u5931\u8D25",f),new Error(`API \u8C03\u7528\u5931\u8D25: ${f.msg||f.message||JSON.stringify(f)}`)}else throw new Error(`HTTP \u72B6\u6001\u7801: ${l.status}`)}catch(l){this.debug("HTTP POST \u9519\u8BEF\uFF0C\u5C1D\u8BD5\u5907\u7528\u8DEF\u5F84",(y=l==null?void 0:l.message)!=null?y:String(l));let f=`${e}/index.php?rest-api=${t}`;this.debug("HTTP POST \u5907\u7528\u8DEF\u5F84",f);try{let T=await(0,m.requestUrl)({url:f,method:"POST",headers:a,body:d});if(T.status===200){let $=JSON.parse(T.text);if($.code===0||$.success)return this.debug("HTTP POST \u5907\u7528\u8DEF\u5F84\u6210\u529F",$),$;throw this.debug("HTTP POST \u5907\u7528\u8DEF\u5F84\u5931\u8D25",$),new Error(`API \u8C03\u7528\u5931\u8D25: ${$.msg||$.message||JSON.stringify($)}`)}else throw new Error(`HTTP \u72B6\u6001\u7801: ${T.status}`)}catch(T){this.debug("HTTP POST \u5907\u7528\u8DEF\u5F84\u4E5F\u5931\u8D25",(S=T==null?void 0:T.message)!=null?S:String(T));let $=`API \u8C03\u7528\u5931\u8D25\uFF0C\u5DF2\u5C1D\u8BD5\u591A\u4E2A\u8DEF\u5F84:
`;throw $+=`\u4E3B\u8DEF\u5F84\u9519\u8BEF: ${l.message}
`,$+=`\u5907\u7528\u8DEF\u5F84\u9519\u8BEF: ${(g=T==null?void 0:T.message)!=null?g:String(T)}
`,$+=`\u8BF7\u6C42\u7684 API: ${t}
`,$+=`\u8BA4\u8BC1\u65B9\u5F0F: ${this.settings.authMode}
`,$+=`\u535A\u5BA2\u5730\u5740: ${e}`,new Error($)}}}async httpGet(t,s){var d,y,S;let e=this.settings.baseUrl.replace(/\/$/,""),n=new URLSearchParams(s).toString(),o=`${e}/?rest-api=${t}${n?"&"+n:""}`;this.debug("HTTP GET",o);let a={};if(this.settings.authMode==="sign"){let g=Date.now(),l=(0,R.default)(`${g}${this.settings.apiKey}`),f=(0,R.default)(`${g}${l}${this.settings.apiKey}`);a={"X-API-Key":this.settings.apiKey,"X-API-Nonce":l,"X-API-Req-Sign":f,"X-API-Timestamp":String(g)}}else this.settings.authMode==="apikey"?a={"X-API-Key":this.settings.apiKey}:this.settings.authMode==="cookie"&&(a={Cookie:this.settings.apiKey});try{let g=await(0,m.requestUrl)({url:o,method:"GET",headers:a});if(g.status===200){let l=JSON.parse(g.text);if(l.code===0||l.success)return this.debug("HTTP GET \u6210\u529F",l),l;throw this.debug("HTTP GET \u5931\u8D25",l),new Error(`API \u8C03\u7528\u5931\u8D25: ${l.msg||l.message||JSON.stringify(l)}`)}else throw new Error(`HTTP \u72B6\u6001\u7801: ${g.status}`)}catch(g){this.debug("HTTP GET \u9519\u8BEF\uFF0C\u5C1D\u8BD5\u5907\u7528\u8DEF\u5F84",(d=g==null?void 0:g.message)!=null?d:String(g));let l=`${e}/index.php?rest-api=${t}${n?"&"+n:""}`;this.debug("HTTP GET \u5907\u7528\u8DEF\u5F84",l);try{let f=await(0,m.requestUrl)({url:l,method:"GET",headers:a});if(f.status===200){let T=JSON.parse(f.text);if(T.code===0||T.success)return this.debug("HTTP GET \u5907\u7528\u8DEF\u5F84\u6210\u529F",T),T;throw this.debug("HTTP GET \u5907\u7528\u8DEF\u5F84\u5931\u8D25",T),new Error(`API \u8C03\u7528\u5931\u8D25: ${T.msg||T.message||JSON.stringify(T)}`)}else throw new Error(`HTTP \u72B6\u6001\u7801: ${f.status}`)}catch(f){this.debug("HTTP GET \u5907\u7528\u8DEF\u5F84\u4E5F\u5931\u8D25",(y=f==null?void 0:f.message)!=null?y:String(f));let T=`API \u8C03\u7528\u5931\u8D25\uFF0C\u5DF2\u5C1D\u8BD5\u591A\u4E2A\u8DEF\u5F84:
`;throw T+=`\u4E3B\u8DEF\u5F84\u9519\u8BEF: ${g.message}
`,T+=`\u5907\u7528\u8DEF\u5F84\u9519\u8BEF: ${(S=f==null?void 0:f.message)!=null?S:String(f)}
`,T+=`\u8BF7\u6C42\u7684 API: ${t}
`,T+=`\u8BA4\u8BC1\u65B9\u5F0F: ${this.settings.authMode}
`,T+=`\u535A\u5BA2\u5730\u5740: ${e}`,new Error(T)}}}async processImages(t,s){var y,S;let e={},n=/!\[[^\]]*\]\(([^)]+)\)/g,o;for(;(o=n.exec(t))!==null;){let g=o[1].trim();if(/^(https?:)?\/\//i.test(g)||g.startsWith("data:"))continue;let l=this.resolveFile(g,s);if(l)try{let f=await this.uploadBinary(l);e[g]=f}catch(f){this.debug("\u56FE\u7247\u4E0A\u4F20\u5931\u8D25",g,(y=f==null?void 0:f.message)!=null?y:String(f))}}let a=/!\[\[([^\]|]+)(?:\|[^\]]*)?\]\]/g;for(;(o=a.exec(t))!==null;){let g=o[1].trim(),l=this.resolveFile(g,s);if(l)try{let f=await this.uploadBinary(l);e[g]=f}catch(f){this.debug("\u56FE\u7247\u4E0A\u4F20\u5931\u8D25",g,(S=f==null?void 0:f.message)!=null?S:String(f))}}let d=t;for(let[g,l]of Object.entries(e))d=d.replace(new RegExp(`!\\[[^\\]]*\\]\\(
?	?${this.escapeRegExp(g)}\\)`,"g"),f=>f.replace(g,l)),d=d.replace(new RegExp(`!\\[\\[${this.escapeRegExp(g)}(\\|[^\\]]*)?\\]\\]`,"g"),`![](${l})`);return{content:d,uploaded:e}}joinPath(t,s){if(s.startsWith("/"))return s.slice(1);let e=t.substring(0,t.lastIndexOf("/")),n=(e?e+"/":"").concat(s).split("/"),o=[];for(let a of n)if(!(!a||a===".")){if(a===".."){o.pop();continue}o.push(a)}return o.join("/")}resolveFile(t,s){var y;let e=this.app.vault,n=this.joinPath(s.path,t),o=e.getFileByPath(n);if(o||(o=e.getFileByPath(t),o))return o;let a=t.split("/").pop();return a&&(y=this.app.vault.getFiles().filter(S=>S.name===a)[0])!=null?y:null}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},H=class extends m.PluginSettingTab{constructor(t,s){super(t,s);this.didRegisterLiveUpdates=!1;this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"obsidian-emlog \u8BBE\u7F6E"}),new m.Setting(t).setName("\u7AD9\u70B9\u5730\u5740").setDesc("\u4F8B\u5982\uFF1Ahttps://yourdomain").addText(d=>d.setPlaceholder("https://yourdomain").setValue(this.plugin.settings.baseUrl).onChange(async y=>{this.plugin.settings.baseUrl=y.trim(),await this.plugin.saveSettings()})),new m.Setting(t).setName("\u9274\u6743\u65B9\u5F0F").setDesc("\u7B7E\u540D\u4F18\u5148\uFF1B\u5F00\u53D1\u53EF\u7528 API Key\uFF1B\u6216\u4F7F\u7528 Cookie").addDropdown(d=>d.addOption("sign","\u7B7E\u540D").addOption("apikey","API Key").addOption("cookie","Cookie").setValue(this.plugin.settings.authMode).onChange(async y=>{this.plugin.settings.authMode=y,await this.plugin.saveSettings()})),new m.Setting(t).setName("API Key").setDesc("\u4EC5\u5728\u514D\u7B7E\u540D\u6216\u7B7E\u540D\u9274\u6743\u4E2D\u4F7F\u7528\uFF1B\u8BF7\u52FF\u6CC4\u9732").addText(d=>d.setPlaceholder("your_api_key").setValue(this.plugin.settings.apiKey).onChange(async y=>{this.plugin.settings.apiKey=y,await this.plugin.saveSettings()})),new m.Setting(t).setName("\u9ED8\u8BA4\u4F5C\u8005 UID").addText(d=>d.setPlaceholder("\u53EF\u7559\u7A7A").setValue(this.plugin.settings.defaultAuthorUid).onChange(async y=>{this.plugin.settings.defaultAuthorUid=y,await this.plugin.saveSettings()}));let s=new m.Setting(t).setName("\u9ED8\u8BA4\u5206\u7C7B").setDesc("\u4ECE\u7AD9\u70B9\u52A8\u6001\u83B7\u53D6\u5206\u7C7B\u5217\u8868\uFF0C\u9009\u62E9\u9ED8\u8BA4\u5206\u7C7B\uFF08\u53EF\u7559\u7A7A\uFF09"),e;s.addDropdown(d=>{e=d,this.plugin.populateSortDropdown(d),d.setValue(this.plugin.settings.defaultSortId||""),d.onChange(async y=>{y!=="__placeholder__"&&(this.plugin.settings.defaultSortId=y,await this.plugin.saveSettings())})}),s.addExtraButton(d=>{d.setIcon("reset").setTooltip("\u5237\u65B0\u5206\u7C7B").onClick(async()=>{d.setDisabled(!0),await this.plugin.refreshSortOptions(),this.plugin.populateSortDropdown(e),e.setValue(this.plugin.settings.defaultSortId||""),a(),d.setDisabled(!1)})});let o=new m.Setting(t).setName("\u5F53\u524D\u7B14\u8BB0 frontmatter \u5206\u7C7B").settingEl.createDiv({text:""});o.style.opacity="0.8";let a=()=>{var f;let d=this.app.workspace.getActiveViewOfType(m.MarkdownView),y=d==null?void 0:d.file;if(!y){o.setText("\u672A\u68C0\u6D4B\u5230\u6D3B\u52A8\u7B14\u8BB0");return}let S=((f=this.app.metadataCache.getFileCache(y))==null?void 0:f.frontmatter)||{},g=S.sort_id!=null?Number(S.sort_id):null;if(!g){o.setText("\u672A\u8BBE\u7F6E\uFF08frontmatter \u4E2D\u65E0 sort_id\uFF09");return}let l=this.plugin.getSortNameByIdPublic(g);l?o.setText(`${l} (ID: ${g})`):o.setText(`\u672A\u5339\u914D\u5230\u5206\u7C7B (ID: ${g})\uFF0C\u8BF7\u5148\u70B9\u51FB\u4E0A\u65B9\u201C\u5237\u65B0\u5206\u7C7B\u201D`)};a(),this.plugin.settings.baseUrl&&this.plugin.refreshSortOptions().then(()=>{this.plugin.populateSortDropdown(e),e.setValue(this.plugin.settings.defaultSortId||""),a()}).catch(()=>{}),this.didRegisterLiveUpdates||(this.plugin.registerEvent(this.app.workspace.on("active-leaf-change",()=>a())),this.plugin.registerEvent(this.app.metadataCache.on("changed",()=>a())),this.didRegisterLiveUpdates=!0)}},K=class extends m.ItemView{constructor(t,s){super(t);this.plugin=s}getViewType(){return G}getDisplayText(){return"EMLOG \u53D1\u5E03"}getIcon(){return"paper-plane"}async onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"EMLOG \u64CD\u4F5C\u9762\u677F"});let s=t.createDiv({cls:"emlog-panel-actions"}),e=s.createEl("button",{text:"\u53D1\u5E03\uFF08\u6B63\u5F0F\uFF09"}),n=s.createEl("button",{text:"\u53D1\u5E03\u4E3A\u8349\u7A3F"}),o=s.createEl("button",{text:"\u53D1\u5E03\u5FAE\u8BED\uFF08\u9009\u4E2D\u6587\u672C\uFF09"}),a=s.createEl("button",{text:"\u5237\u65B0\u5206\u7C7B"}),d=s.createEl("button",{text:"\u6253\u5F00\u8BBE\u7F6E"}),y=s.createEl("button",{text:"\u81EA\u5B9A\u4E49\u53D1\u5E03\u2026"}),S=t.createEl("div",{cls:"emlog-panel-log"});S.setAttr("style","margin-top:8px;font-size:12px;opacity:.85;white-space:pre-wrap;");let g=l=>{S.setText(`[${new Date().toLocaleTimeString()}] ${l}`)};e.onclick=async()=>{g("\u53D1\u5E03\u4E2D..."),await this.plugin.publishCurrentNote(!1)},n.onclick=async()=>{g("\u8349\u7A3F\u53D1\u5E03\u4E2D..."),await this.plugin.publishCurrentNote(!0)},o.onclick=async()=>{g("\u53D1\u5E03\u5FAE\u8BED\u4E2D..."),await this.plugin.publishNote()},a.onclick=async()=>{g("\u5237\u65B0\u5206\u7C7B\u4E2D..."),await this.plugin.refreshSortOptions(),g("\u5206\u7C7B\u5DF2\u5237\u65B0")},d.onclick=()=>{var l;return(l=this.app.setting)==null?void 0:l.open()},y.onclick=()=>{var l;return this.plugin.openPublishModal(((l=this.app.workspace.getActiveViewOfType(m.MarkdownView))==null?void 0:l.file)||this.plugin.lastMarkdownFile)}}async onClose(){this.contentEl.empty()}},q=class extends m.Modal{constructor(t,s,e,n){super(t);this.title="";this.sortId="";this.tags="";this.excerpt="";this.draft=!1;this.postDate="";this.coverImage="";this.plugin=s,this.file=e,this.editor=n}async onOpen(){var d,y,S;let{contentEl:t,modalEl:s}=this;s.addClass("mod-publish-emlog"),t.empty(),t.createEl("h3",{text:"\u81EA\u5B9A\u4E49\u53D1\u5E03\u5230 EMLOG"});let e=this.editor?this.editor.getValue():await this.app.vault.cachedRead(this.file),n=this.plugin.extractFrontmatter(this.file)||{};this.title=this.plugin.deriveTitle(e,this.file,n),this.excerpt=this.plugin.deriveExcerpt(e,n),this.tags=Array.isArray(n.tags)?n.tags.map(String).join(","):typeof n.tags=="string"?n.tags:"",this.sortId=((d=n.sort_id)!=null?d:this.plugin.settings.defaultSortId)?String((y=n.sort_id)!=null?y:this.plugin.settings.defaultSortId):"",this.draft=n.draft==="y"||n.draft===!0||this.plugin.settings.defaultDraft,this.coverImage=n.cover_image||n.coverImage||"",new m.Setting(t).setName("\u6807\u9898").addText(g=>g.setValue(this.title).onChange(l=>this.title=l)),new m.Setting(t).setName("\u6458\u8981").addTextArea(g=>g.setValue(this.excerpt).onChange(l=>this.excerpt=l)),new m.Setting(t).setName("\u6807\u7B7E\uFF08\u9017\u53F7\u5206\u9694\uFF09").addText(g=>g.setValue(this.tags).onChange(l=>this.tags=l)),new m.Setting(t).setName("\u5C01\u9762\u56FE").setDesc("\u56FE\u7247URL\u6216\u672C\u5730\u56FE\u7247\u8DEF\u5F84").addText(g=>g.setValue(this.coverImage).onChange(l=>this.coverImage=l));let o=new m.Setting(t).setName("\u5206\u7C7B"),a=document.createElement("select");if(a.appendChild(new Option("\uFF08\u4E0D\u6307\u5B9A\uFF09","")),(S=this.plugin.cachedSorts)!=null&&S.length)for(let g of this.plugin.cachedSorts){let l=" ".repeat(g.depth*2);a.appendChild(new Option(`${l}${g.name}`,String(g.id)))}a.value=this.sortId,a.onchange=()=>this.sortId=a.value||"",o.settingEl.appendChild(a),new m.Setting(t).addButton(g=>g.setButtonText("\u5237\u65B0\u5206\u7C7B").onClick(async()=>{for(await this.plugin.refreshSortOptions();a.firstChild;)a.removeChild(a.firstChild);a.appendChild(new Option("\uFF08\u4E0D\u6307\u5B9A\uFF09",""));for(let l of this.plugin.cachedSorts){let f=" ".repeat(l.depth*2);a.appendChild(new Option(`${f}${l.name}`,String(l.id)))}this.sortId&&(a.value=this.sortId)})),new m.Setting(t).setName("\u8349\u7A3F").addToggle(g=>g.setValue(this.draft).onChange(l=>this.draft=l)),new m.Setting(t).setName("\u53D1\u5E03\u65F6\u95F4\uFF08\u53EF\u9009\uFF09").setDesc("\u683C\u5F0F\uFF1AYYYY-MM-DD HH:mm:ss").addText(g=>g.setPlaceholder("2025-08-15 10:00:00").onChange(l=>this.postDate=l)),new m.Setting(t).addButton(g=>g.setCta().setButtonText("\u53D1\u5E03").onClick(async()=>{let l=this.editor?this.editor.getValue():await this.app.vault.cachedRead(this.file);await this.plugin.publishCore(this.file,l,!1,{title:this.title,excerpt:this.excerpt,tags:this.tags,sortId:this.sortId,draft:this.draft,postDate:this.postDate||void 0,coverImage:this.coverImage||void 0}),this.close()}))}};
